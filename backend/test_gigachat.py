
#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã GigaChat API
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from gigachat_integration import (
    get_access_token,
    chat_completion,
    GigaChatAIClient,
    extract_transactions_with_fallback,
    is_transaction_message
)

def test_token():
    """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞"""
    print("=" * 60)
    print("–¢–ï–°–¢ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞")
    print("=" * 60)
    
    try:
        token = get_access_token()
        if token:
            print(f"‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
            print(f"   –¢–æ–∫–µ–Ω (–ø–µ—Ä–≤—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤): {token[:20]}...")
            return token
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω")
            return None
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞: {str(e)}")
        return None

def test_chat_completion(token):
    """–¢–µ—Å—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ API"""
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ 2: –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ GigaChat API")
    print("=" * 60)
    
    if not token:
        print("‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞")
        return False
    
    try:
        test_message = "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
        print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: '{test_message}'")
        
        response = chat_completion(token, test_message, max_tokens=100)
        
        if 'error' in response:
            print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.get('error')}")
            print(f"   –°–æ–æ–±—â–µ–Ω–∏–µ: {response.get('message', '')[:200]}")
            return False
        
        if 'choices' in response and len(response['choices']) > 0:
            answer = response['choices'][0].get('message', {}).get('content', '')
            print(f"‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!")
            print(f"   –û—Ç–≤–µ—Ç: {answer[:100]}...")
            return True
        else:
            print("‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞")
            print(f"   –û—Ç–≤–µ—Ç: {response}")
            return False
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: {str(e)}")
        return False

def test_transaction_extraction():
    """–¢–µ—Å—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"""
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")
    print("=" * 60)
    
    test_messages = [
        # –ü—Ä–æ—Å—Ç—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        "–ö—É–ø–∏–ª —Ö–ª–µ–± –∑–∞ 50 —Ä—É–±–ª–µ–π –∏ –º–æ–ª–æ–∫–æ –∑–∞ 80 —Ä—É–±–ª–µ–π",
        "–ü–æ–ª—É—á–∏–ª –∑–∞—Ä–ø–ª–∞—Ç—É 85000 —Ä—É–±–ª–µ–π",
        "–í—á–µ—Ä–∞ –ø–æ—Ç—Ä–∞—Ç–∏–ª 2000 –Ω–∞ –æ–±–µ–¥ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ",
        
        # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        "–°–µ–≥–æ–¥–Ω—è –∫—É–ø–∏–ª –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ 1500 —Ä—É–±–ª–µ–π, –∑–∞–ø–ª–∞—Ç–∏–ª –∑–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç 500 —Ä—É–±–ª–µ–π –∏ –∫—É–ø–∏–ª –±–∏–ª–µ—Ç—ã –≤ –∫–∏–Ω–æ –∑–∞ 800 —Ä—É–±–ª–µ–π",
        "–ü–æ–ª—É—á–∏–ª –∑–∞—Ä–ø–ª–∞—Ç—É 85000 —Ä—É–±–ª–µ–π –∏ –ø—Ä–µ–º–∏—é 15000 —Ä—É–±–ª–µ–π",
        
        # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –¥–∞—Ç–∞–º–∏
        "15 –¥–µ–∫–∞–±—Ä—è –ø–æ—Ç—Ä–∞—Ç–∏–ª 3000 –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏",
        "–í –ø—Ä–æ—à–ª—É—é –ø—è—Ç–Ω–∏—Ü—É –ø–æ–ª—É—á–∏–ª 5000 —Ä—É–±–ª–µ–π –∑–∞ —Ñ—Ä–∏–ª–∞–Ω—Å",
        
        # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
        "–ó–∞–ø–ª–∞—Ç–∏–ª –∑–∞ –±–µ–Ω–∑–∏–Ω 2500 —Ä—É–±–ª–µ–π",
        "–ö—É–ø–∏–ª –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –Ω–∞ 1200 —Ä—É–±–ª–µ–π –≤ –∞–ø—Ç–µ–∫–µ",
        "–ü–æ–ª—É—á–∏–ª –¥–∏–≤–∏–¥–µ–Ω–¥—ã 5000 —Ä—É–±–ª–µ–π",
        
        # –°–ª–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
        "–ü–æ—Ç—Ä–∞—Ç–∏–ª –æ–∫–æ–ª–æ 5000 —Ä—É–±–ª–µ–π –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ",
        "–ó–∞—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∏–º–µ—Ä–Ω–æ 30000 —Ä—É–±–ª–µ–π –Ω–∞ –ø–æ–¥—Ä–∞–±–æ—Ç–∫–µ",
        "–ó–∞–ø–ª–∞—Ç–∏–ª –∑–∞ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ 4500 —Ä—É–±–ª–µ–π –∑–∞ –Ω–æ—è–±—Ä—å",
        
        # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–µ–∑ —è–≤–Ω–æ–π —Å—É–º–º—ã
        "–ö—É–ø–∏–ª –∫–æ—Ñ–µ",
        "–ü–æ–ª—É—á–∏–ª –¥–µ–Ω—å–≥–∏",
        
        # –° —Ä–∞–∑–Ω—ã–º–∏ –≤–∞–ª—é—Ç–∞–º–∏
        "–ü–æ—Ç—Ä–∞—Ç–∏–ª 100 –¥–æ–ª–ª–∞—Ä–æ–≤ –Ω–∞ –ø–æ–∫—É–ø–∫–∏",
        "–ü–æ–ª—É—á–∏–ª 500 –µ–≤—Ä–æ",
    ]
    
    for i, message in enumerate(test_messages, 1):
        print(f"\n--- –¢–µ—Å—Ç {i}: '{message}' ---")
        try:
            result = extract_transactions_with_fallback(message)
            
            if result and result.get("transactions"):
                transactions = result.get("transactions", [])
                print(f"‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {len(transactions)}")
                
                for j, trans in enumerate(transactions, 1):
                    print(f"\n   –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è {j}:")
                    print(f"   - –¢–∏–ø: {trans.get('type', 'N/A')}")
                    print(f"   - –°—É–º–º–∞: {trans.get('amount', 'N/A')}")
                    print(f"   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {trans.get('category', 'N/A')}")
                    print(f"   - –î–∞—Ç–∞: {trans.get('date', 'N/A')}")
                    print(f"   - –ù–∞–∑–≤–∞–Ω–∏–µ: {trans.get('title', 'N/A')}")
                
                if result.get("analysis"):
                    print(f"\n   –ê–Ω–∞–ª–∏–∑: {result.get('analysis')[:100]}...")
                
                if result.get("warnings"):
                    print(f"\n   ‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: {result.get('warnings')}")
            else:
                print("‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã")
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
            import traceback
            traceback.print_exc()

def test_client_availability():
    """–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞"""
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GigaChatAIClient")
    print("=" * 60)
    
    try:
        client = GigaChatAIClient()
        is_available = client._is_available()
        
        if is_available:
            print("‚úÖ GigaChatAIClient –¥–æ—Å—Ç—É–ø–µ–Ω")
        else:
            print("‚ùå GigaChatAIClient –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            print("   –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è fallback –º–µ—Ç–æ–¥")
        
        return is_available
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
        return False

def test_message_classification():
    """–¢–µ—Å—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è vs –≤–æ–ø—Ä–æ—Å)"""
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ 5: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π")
    print("=" * 60)
    
    test_cases = [
        # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–æ–ª–∂–Ω—ã –≤–µ—Ä–Ω—É—Ç—å True)
        ("–ö—É–ø–∏–ª —Ö–ª–µ–± –∑–∞ 50 —Ä—É–±–ª–µ–π", True),
        ("–ü–æ–ª—É—á–∏–ª –∑–∞—Ä–ø–ª–∞—Ç—É 85000", True),
        ("–ü–æ—Ç—Ä–∞—Ç–∏–ª 2000 –Ω–∞ –æ–±–µ–¥", True),
        ("–ó–∞—Ä–∞–±–æ—Ç–∞–ª 30000 —Ä—É–±–ª–µ–π", True),
        ("–ó–∞–ø–ª–∞—Ç–∏–ª –∑–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç 500 —Ä—É–±–ª–µ–π", True),
        ("–ö—É–ø–∏–ª –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∞ 1500 —Ä—É–±–ª–µ–π", True),
        
        # –í–æ–ø—Ä–æ—Å—ã (–¥–æ–ª–∂–Ω—ã –≤–µ—Ä–Ω—É—Ç—å False)
        ("–ö–∞–∫ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –¥–µ–Ω—å–≥–∏?", False),
        ("–ß—Ç–æ —Ç–∞–∫–æ–µ –±—é–¥–∂–µ—Ç?", False),
        ("–ü–æ—á–µ–º—É —è —Ç—Ä–∞—á—É —Ç–∞–∫ –º–Ω–æ–≥–æ?", False),
        ("–ö–æ–≥–¥–∞ –ª—É—á—à–µ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å?", False),
        ("–ì–¥–µ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç?", False),
        ("–°–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å?", False),
        ("–ö–∞–∫–æ–π –±–∞–Ω–∫ –ª—É—á—à–µ?", False),
        ("–ö–∞–∫–∞—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞?", False),
        ("–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–µ—Å—Ç–∏ –±—é–¥–∂–µ—Ç?", False),
        ("–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –¥–æ–ª–≥–∞–º–∏?", False),
        
        # –°–º–µ—à–∞–Ω–Ω—ã–µ —Å–ª—É—á–∞–∏
        ("–°–∫–æ–ª—å–∫–æ —è –ø–æ—Ç—Ä–∞—Ç–∏–ª –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ?", False),  # –í–æ–ø—Ä–æ—Å –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
        ("–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?", False),  # –í–æ–ø—Ä–æ—Å –æ —Ñ—É–Ω–∫—Ü–∏–∏
        ("–ö—É–ø–∏–ª —Ö–ª–µ–±, —Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç?", True),  # –ï—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è + –≤–æ–ø—Ä–æ—Å
        ("–ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ?", False),  # –í–æ–ø—Ä–æ—Å, –Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
    ]
    
    passed = 0
    failed = 0
    
    for message, expected in test_cases:
        result = is_transaction_message(message)
        status = "‚úÖ" if result == expected else "‚ùå"
        if result == expected:
            passed += 1
        else:
            failed += 1
        
        print(f"{status} '{message[:50]}...' -> {result} (–æ–∂–∏–¥–∞–ª–æ—Å—å {expected})")
    
    print(f"\n–†–µ–∑—É–ª—å—Ç–∞—Ç: {passed} –ø—Ä–æ–π–¥–µ–Ω–æ, {failed} –ø—Ä–æ–≤–∞–ª–µ–Ω–æ –∏–∑ {len(test_cases)}")


def test_detailed_analysis():
    """–¢–µ—Å—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ 6: –î–µ—Ç–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑")
    print("=" * 60)
    
    test_message = "–ö—É–ø–∏–ª —Ö–ª–µ–± –∑–∞ 50 —Ä—É–±–ª–µ–π, —Å–Ω–∏–∫–µ—Ä—Å –∑–∞ 100 —Ä—É–±–ª–µ–π, –ø–æ—Ç–æ–º –º–∞–º–∞ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞ 10000 —Ä—É–±–ª–µ–π –∑–∞ —Ö–æ—Ä–æ—à—É—é —É—á–µ–±—É"
    
    print(f"\n–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: '{test_message}'")
    print("\n–û–∂–∏–¥–∞–µ–º—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:")
    print("  1. –†–∞—Å—Ö–æ–¥: —Ö–ª–µ–±, 50 —Ä—É–±, –∫–∞—Ç–µ–≥–æ—Ä–∏—è Food")
    print("  2. –†–∞—Å—Ö–æ–¥: —Å–Ω–∏–∫–µ—Ä—Å, 100 —Ä—É–±, –∫–∞—Ç–µ–≥–æ—Ä–∏—è Food")
    print("  3. –î–æ—Ö–æ–¥: –æ—Ç –º–∞–º—ã, 10000 —Ä—É–±, –∫–∞—Ç–µ–≥–æ—Ä–∏—è Gift")
    print("\n–û–∂–∏–¥–∞–µ–º—ã–π –∞–Ω–∞–ª–∏–∑:")
    print("  - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º (–º–∏–Ω–∏–º—É–º 8-10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)")
    print("  - –î–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –æ—Ü–µ–Ω–∫—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∞–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
    print("  - –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑")
    
    print("\n" + "-" * 60)
    print("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø:")
    print("-" * 60)
    
    try:
        result = extract_transactions_with_fallback(test_message)
        
        if not result:
            print("‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π")
            return False
        
        transactions = result.get("transactions", [])
        extracted_info = result.get("extracted_info", {})
        analysis = result.get("analysis", "")
        warnings = result.get("warnings", [])
        questions = result.get("questions", [])
        
        print(f"\n‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {len(transactions)}")
        print(f"   –û–∂–∏–¥–∞–ª–æ—Å—å: 3 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (2 —Ä–∞—Å—Ö–æ–¥–∞ + 1 –¥–æ—Ö–æ–¥)")
        
        if len(transactions) != 3:
            print(f"   ‚ö†Ô∏è  –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: –Ω–∞–π–¥–µ–Ω–æ {len(transactions)}, –æ–∂–∏–¥–∞–ª–æ—Å—å 3")
        
        print("\n" + "-" * 60)
        print("–î–ï–¢–ê–õ–ò –¢–†–ê–ù–ó–ê–ö–¶–ò–ô:")
        print("-" * 60)
        
        total_expense = 0
        total_income = 0
        
        for i, trans in enumerate(transactions, 1):
            trans_type = trans.get('type', 'N/A')
            amount = trans.get('amount')
            title = trans.get('title', 'N/A')
            category = trans.get('category', 'N/A')
            date = trans.get('date', 'N/A')
            confidence = trans.get('confidence', 'N/A')
            
            print(f"\n  –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è {i}:")
            print(f"    –¢–∏–ø: {trans_type}")
            print(f"    –ù–∞–∑–≤–∞–Ω–∏–µ: {title}")
            print(f"    –°—É–º–º–∞: {amount} —Ä—É–±" if amount else "    –°—É–º–º–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞")
            print(f"    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}")
            print(f"    –î–∞—Ç–∞: {date}")
            print(f"    –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence}")
            
            if trans_type == "expense" and amount:
                total_expense += amount
            elif trans_type == "income" and amount:
                total_income += amount
        
        print("\n" + "-" * 60)
        print("–°–í–û–î–ö–ê:")
        print("-" * 60)
        print(f"  –í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: {total_expense} —Ä—É–± (–æ–∂–∏–¥–∞–ª–æ—Å—å: 150 —Ä—É–±)")
        print(f"  –í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–æ–≤: {total_income} —Ä—É–± (–æ–∂–∏–¥–∞–ª–æ—Å—å: 10000 —Ä—É–±)")
        print(f"  –ë–∞–ª–∞–Ω—Å: {total_income - total_expense} —Ä—É–±")
        
        if extracted_info:
            print(f"\n  –ò–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:")
            print(f"    - –û–±—â–∞—è —Å—É–º–º–∞ –¥–æ—Ö–æ–¥–æ–≤: {extracted_info.get('total_income', 'N/A')}")
            print(f"    - –û–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤: {extracted_info.get('total_expense', 'N/A')}")
            print(f"    - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {extracted_info.get('transactions_count', 'N/A')}")
        
        print("\n" + "-" * 60)
        print("–§–ò–ù–ê–ù–°–û–í–´–ô –ê–ù–ê–õ–ò–ó:")
        print("-" * 60)
        
        if analysis:
            print(f"\n{analysis}")
            print(f"\n  –î–ª–∏–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞: {len(analysis)} —Å–∏–º–≤–æ–ª–æ–≤")
            sentences = analysis.count('.') + analysis.count('!') + analysis.count('?')
            print(f"  –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: {sentences}")
            
            if len(analysis) < 500:
                print("  ‚ö†Ô∏è  –ê–Ω–∞–ª–∏–∑ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–æ–∂–∏–¥–∞–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 8-10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)")
            else:
                print("  ‚úÖ –ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
            analysis_lower = analysis.lower()
            checks = {
                "–æ—Ü–µ–Ω–∫–∞": any(word in analysis_lower for word in ["–æ—Ü–µ–Ω–∫–∞", "—Å—É–º–º–∞", "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", "—Ç–∏–ø"]),
                "–∫–∞—Ç–µ–≥–æ—Ä–∏–∏": any(word in analysis_lower for word in ["–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "–∫–∞—Ç–µ–≥–æ—Ä–∏–∏", "—Ä–∞—Å—Ö–æ–¥", "–¥–æ—Ö–æ–¥"]),
                "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏": any(word in analysis_lower for word in ["—Ä–µ–∫–æ–º–µ–Ω–¥", "—Å–æ–≤–µ—Ç", "—Å–ª–µ–¥—É–µ—Ç", "—Å—Ç–æ–∏—Ç"]),
                "—Å–æ–≤–µ—Ç—ã": any(word in analysis_lower for word in ["—Å–æ–≤–µ—Ç", "—Ä–µ–∫–æ–º–µ–Ω–¥", "–º–æ–∂–Ω–æ", "–Ω—É–∂–Ω–æ"]),
            }
            
            print("\n  –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞:")
            for check_name, passed in checks.items():
                status = "‚úÖ" if passed else "‚ùå"
                print(f"    {status} {check_name.capitalize()}: {'–Ω–∞–π–¥–µ–Ω–æ' if passed else '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}")
        else:
            print("‚ùå –ê–Ω–∞–ª–∏–∑ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
        
        if warnings:
            print("\n" + "-" * 60)
            print("–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø:")
            print("-" * 60)
            for warning in warnings:
                print(f"  ‚ö†Ô∏è  {warning}")
        
        if questions:
            print("\n" + "-" * 60)
            print("–í–û–ü–†–û–°–´ –î–õ–Ø –£–¢–û–ß–ù–ï–ù–ò–Ø:")
            print("-" * 60)
            for question in questions:
                print(f"  ‚ùì {question}")
        
        print("\n" + "=" * 60)
        print("–ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê:")
        print("=" * 60)
        
        score = 0
        max_score = 7
        
        if len(transactions) == 3:
            score += 1
            print("‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")
        else:
            print(f"‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {len(transactions)} –≤–º–µ—Å—Ç–æ 3")
        
        if total_expense == 150:
            score += 1
            print("‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ (150 —Ä—É–±)")
        else:
            print(f"‚ö†Ô∏è  –°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤: {total_expense} —Ä—É–± (–æ–∂–∏–¥–∞–ª–æ—Å—å 150 —Ä—É–±)")
        
        if total_income == 10000:
            score += 1
            print("‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–æ—Ö–æ–¥–æ–≤ (10000 —Ä—É–±)")
        else:
            print(f"‚ö†Ô∏è  –°—É–º–º–∞ –¥–æ—Ö–æ–¥–æ–≤: {total_income} —Ä—É–± (–æ–∂–∏–¥–∞–ª–æ—Å—å 10000 —Ä—É–±)")
        
        if analysis and len(analysis) >= 500:
            score += 1
            print("‚úÖ –ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π")
        else:
            print("‚ùå –ê–Ω–∞–ª–∏–∑ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π")
        
        if analysis and any(word in analysis.lower() for word in ["—Ä–µ–∫–æ–º–µ–Ω–¥", "—Å–æ–≤–µ—Ç"]):
            score += 1
            print("‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
        else:
            print("‚ùå –ê–Ω–∞–ª–∏–∑ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π")
        
        if analysis and any(word in analysis.lower() for word in ["–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "–∫–∞—Ç–µ–≥–æ—Ä–∏–∏"]):
            score += 1
            print("‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π")
        else:
            print("‚ùå –ê–Ω–∞–ª–∏–∑ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π")
        
        if analysis and sentences >= 8:
            score += 1
            print(f"‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –∞–Ω–∞–ª–∏–∑–µ ({sentences})")
        else:
            print(f"‚ö†Ô∏è  –ú–∞–ª–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –∞–Ω–∞–ª–∏–∑–µ ({sentences}, –æ–∂–∏–¥–∞–ª–æ—Å—å –º–∏–Ω–∏–º—É–º 8)")
        
        print(f"\nüìä –û—Ü–µ–Ω–∫–∞: {score}/{max_score} ({score*100//max_score}%)")
        
        return score >= 5
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {str(e)}")
        import traceback
        traceback.print_exc()
        return False

def test_chat_responses():
    """–¢–µ—Å—Ç –æ–±—ã—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Ç–µ"""
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ 7: –û—Ç–≤–µ—Ç—ã –Ω–∞ –æ–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã")
    print("=" * 60)
    
    token = get_access_token()
    if not token:
        print("‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞")
        return
    
    questions = [
        "–ö–∞–∫ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –¥–µ–Ω—å–≥–∏?",
        "–ß—Ç–æ —Ç–∞–∫–æ–µ –±—é–¥–∂–µ—Ç?",
        "–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å?",
        "–ö–∞–∫–∏–µ –µ—Å—Ç—å —Å–ø–æ—Å–æ–±—ã –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è?",
        "–ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥?",
        "–ö–∞–∫ –≤–µ—Å—Ç–∏ —É—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤?",
        "–ö–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ?",
    ]
    
    for i, question in enumerate(questions, 1):
        print(f"\n--- –í–æ–ø—Ä–æ—Å {i}: '{question}' ---")
        try:
            response = chat_completion(token, question, max_tokens=200)
            
            if 'error' in response:
                print(f"‚ùå –û—à–∏–±–∫–∞: {response.get('error')}")
            else:
                answer = response.get('choices', [{}])[0].get('message', {}).get('content', '')
                print(f"‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω ({len(answer)} —Å–∏–º–≤–æ–ª–æ–≤)")
                print(f"   –û—Ç–≤–µ—Ç: {answer[:150]}...")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï GIGACHAT API")
    print("=" * 60 + "\n")
    
    # –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
    token = test_token()
    
    # –¢–µ—Å—Ç 2: –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
    if token:
        test_chat_completion(token)
    
    # –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
    test_client_availability()
    
    # –¢–µ—Å—Ç 4: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    test_transaction_extraction()
    
    # –¢–µ—Å—Ç 5: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    test_message_classification()
    
    # –¢–µ—Å—Ç 6: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    test_detailed_analysis()
    
    # –¢–µ—Å—Ç 7: –û—Ç–≤–µ—Ç—ã –Ω–∞ –æ–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
    test_chat_responses()
    
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")
    print("=" * 60)
    print("\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º.")
    print("–ï—Å–ª–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ, GigaChat API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")

if __name__ == "__main__":
    main()

